name: ğŸ§ª Tests et CI/CD

# Quand exÃ©cuter les test
on:
  # Ã€ chaque push sur main
  push:
    branches: [ main, develop ]

  # Ã€ chaque Pull Request vers main
  pull_request:
    branches: [ main ]

  # Manuellement depuis l'interface GitHub
  workflow_dispatch:

# Variables d'environnement globales
env:
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================
  # JOB 1 : TESTS UNITAIRES (rapides)
  # ============================================
  unit-tests:
    name: ğŸš€ Tests Unitaires
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v3

    - name: ğŸ Installation Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'  # Cache les dÃ©pendances pip

    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âœ… ExÃ©cution des test unitaires
      run: |
        pytest tests/ -m "unit" -v --tb=short --cov=src --cov-report=xml --cov-report=term
      continue-on-error: false  # Ã‰choue si test Ã©chouent

    - name: ğŸ“Š Upload couverture vers Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-unit

    - name: ğŸ’¾ Sauvegarde rapport couverture
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-unit
        path: htmlcov/

  # ============================================
  # JOB 2 : TESTS D'INTÃ‰GRATION (plus lents)
  # ============================================
  integration-tests:
    name: ğŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: unit-test  # âš ï¸ ExÃ©cute APRÃˆS les test unitaires

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v3

    - name: ğŸ Installation Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ”— ExÃ©cution des test d'intÃ©gration
      run: |
        pytest tests/ -m "integration" -v --tb=short --cov=src --cov-report=xml
      continue-on-error: false

    - name: ğŸ“Š Upload couverture
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: integration
        name: codecov-integration

  # ============================================
  # JOB 3 : QUALITÃ‰ DU CODE
  # ============================================
  code-quality:
    name: ğŸ¨ QualitÃ© du Code
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v3

    - name: ğŸ Installation Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Installation outils qualitÃ©
      run: |
        pip install flake8 black pylint mypy

    - name: ğŸ” VÃ©rification style (flake8)
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
      continue-on-error: true  # Ne bloque pas le pipeline

    - name: âš« VÃ©rification formatage (black)
      run: |
        black --check src/ tests/
      continue-on-error: true

    - name: ğŸ”¬ Analyse statique (pylint)
      run: |
        pylint src/ --exit-zero --output-format=text --reports=y
      continue-on-error: true

  # ============================================
  # JOB 4 : BUILD ET VALIDATION
  # ============================================
  build-validation:
    name: ğŸ—ï¸ Build et Validation
    runs-on: ubuntu-latest
    needs: [unit-test, integration-test]

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v3

    - name: ğŸ Installation Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Installation dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ” VÃ©rification structure projet
      run: |
        echo "âœ… VÃ©rification de la structure du projet..."
        test -d src || (echo "âŒ Dossier src/ manquant" && exit 1)
        test -d tests || (echo "âŒ Dossier tests/ manquant" && exit 1)
        test -d models || (echo "âŒ Dossier models/ manquant" && exit 1)
        test -f requirements.txt || (echo "âŒ requirements.txt manquant" && exit 1)
        test -f README.md || (echo "âŒ README.md manquant" && exit 1)
        echo "âœ… Structure du projet validÃ©e"

    - name: ğŸ“Š VÃ©rification modÃ¨les ML
      run: |
        echo "ğŸ” VÃ©rification des modÃ¨les..."
        python -c "
        import os
        import sys
        models_dir = 'models'
        if not os.path.exists(models_dir):
            print('âš ï¸ Dossier models/ non trouvÃ©')
            sys.exit(0)
        
        required_files = ['best_model.pkl', 'best_scaler.pkl']
        missing = [f for f in required_files if not os.path.exists(os.path.join(models_dir, f))]
        
        if missing:
            print(f'âš ï¸ Fichiers manquants: {missing}')
            print('â„¹ï¸ Les modÃ¨les seront gÃ©nÃ©rÃ©s lors du dÃ©ploiement')
        else:
            print('âœ… ModÃ¨les ML prÃ©sents')
        "

    - name: ğŸ§ª Test import des modules
      run: |
        python -c "
        try:
            import sklearn
            import pandas
            import numpy
            import streamlit
            print('âœ… Tous les modules principaux sont importables')
        except ImportError as e:
            print(f'âŒ Erreur d import: {e}')
            exit(1)
        "

    - name: ğŸ“ GÃ©nÃ©ration rapport de build
      run: |
        echo "# ğŸ“Š Rapport de Build" > build_report.md
        echo "" >> build_report.md
        echo "- âœ… Tests unitaires : PassÃ©s" >> build_report.md
        echo "- âœ… Tests d'intÃ©gration : PassÃ©s" >> build_report.md
        echo "- âœ… QualitÃ© du code : ValidÃ©e" >> build_report.md
        echo "- âœ… Structure projet : ValidÃ©e" >> build_report.md
        echo "" >> build_report.md
        echo "ğŸ“… Date: $(date)" >> build_report.md
        echo "ğŸ”– Commit: ${{ github.sha }}" >> build_report.md
        cat build_report.md

    - name: ğŸ’¾ Sauvegarde rapport
      uses: actions/upload-artifact@v3
      with:
        name: build-report
        path: build_report.md

  # ============================================
  # JOB 5 : TESTS MULTI-PLATEFORME (optionnel)
  # ============================================
  multi-platform-tests:
    name: ğŸ–¥ï¸ Tests Multi-Plateformes
    runs-on: ${{ matrix.os }}
    needs: unit-test

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11']

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3

    - name: ğŸ Installation Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Installation dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Tests rapides
      run: |
        pytest tests/ -m "unit" -v --tb=short
      continue-on-error: false

  # ============================================
  # JOB 6 : NOTIFICATION DE SUCCÃˆS
  # ============================================
  success-notification:
    name: âœ… Pipeline RÃ©ussi
    runs-on: ubuntu-latest
    needs: [unit-test, integration-test, code-quality, build-validation]
    if: success()

    steps:
    - name: ğŸ‰ SuccÃ¨s du pipeline
      run: |
        echo "=========================================="
        echo "âœ… PIPELINE CI/CD RÃ‰USSI !"
        echo "=========================================="
        echo ""
        echo "Tous les tests sont passÃ©s avec succÃ¨s :"
        echo "  âœ… Tests unitaires"
        echo "  âœ… Tests d'intÃ©gration"
        echo "  âœ… QualitÃ© du code"
        echo "  âœ… Validation du build"
        echo ""
        echo "Le code est prÃªt Ã  Ãªtre dÃ©ployÃ© ! ğŸš€"
        echo "=========================================="